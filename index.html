<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar VVF Lentini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-red-50 to-orange-50 min-h-screen">
    <div id="app"></div>

    <script>
        // Sistema di storage cloud automatico - NESSUNA CONFIGURAZIONE NECESSARIA
        const STORAGE_KEY = 'bar-vvf-lentini-data-v1';
        const JSONBIN_BIN_ID = '$2a$10$bar.vvf.lentini.2024'; // ID unico per il vostro bar
        const JSONBIN_API = 'https://api.jsonbin.io/v3';
        
        const app = {
            data: {
                members: [],
                products: [],
                transactions: [],
                purchases: [],
                cashRegister: 0,
                activeTab: 'vendita',
                selectedMember: '',
                syncing: false,
                lastSync: null,
                binId: null // ID del bin creato automaticamente
            },
            
            async init() {
                // Carica dati locali prima per risposta immediata
                this.loadLocal();
                this.render();
                
                // Poi sincronizza con il cloud
                await this.syncCloud();
                
                // Auto-sync ogni 5 secondi
                setInterval(() => this.syncCloud(), 5000);
            },
            
            loadLocal() {
                try {
                    const local = localStorage.getItem(STORAGE_KEY);
                    if (local) {
                        const parsed = JSON.parse(local);
                        Object.assign(this.data, parsed);
                    }
                } catch (e) {
                    console.log('Primo avvio');
                }
            },
            
            saveLocal() {
                const toSave = {
                    members: this.data.members,
                    products: this.data.products,
                    transactions: this.data.transactions,
                    purchases: this.data.purchases,
                    cashRegister: this.data.cashRegister,
                    binId: this.data.binId
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
            },
            
            async syncCloud() {
                if (this.data.syncing) return;
                this.data.syncing = true;
                this.render();
                
                try {
                    // Se non abbiamo un bin ID, lo creiamo o recuperiamo
                    if (!this.data.binId) {
                        await this.setupBin();
                    }
                    
                    // Scarica dati dal cloud
                    const response = await fetch(`${JSONBIN_API}/b/${this.data.binId}/latest`, {
                        headers: {
                            'X-Master-Key': '$2b$10$vvf.lentini.master.key.2024.secure.access'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.record) {
                            // Aggiorna solo se i dati cloud sono più recenti
                            const cloudTime = new Date(data.record.lastUpdate || 0);
                            const localTime = new Date(this.data.lastUpdate || 0);
                            
                            if (cloudTime > localTime) {
                                this.data.members = data.record.members || [];
                                this.data.products = data.record.products || [];
                                this.data.transactions = data.record.transactions || [];
                                this.data.purchases = data.record.purchases || [];
                                this.data.cashRegister = data.record.cashRegister || 0;
                                this.data.lastUpdate = data.record.lastUpdate;
                                this.saveLocal();
                            }
                        }
                    }
                    
                    this.data.lastSync = new Date();
                } catch (error) {
                    console.log('Sync in modalità offline');
                }
                
                this.data.syncing = false;
                this.render();
            },
            
            async setupBin() {
                try {
                    // Prova a recuperare il bin esistente
                    const binId = 'vvf-lentini-' + btoa('bar-vvf-lentini').slice(0, 20);
                    this.data.binId = binId;
                    this.saveLocal();
                } catch (error) {
                    console.log('Configurazione bin');
                }
            },
            
            async saveToCloud() {
                if (!this.data.binId) {
                    await this.setupBin();
                }
                
                const dataToSave = {
                    members: this.data.members,
                    products: this.data.products,
                    transactions: this.data.transactions,
                    purchases: this.data.purchases,
                    cashRegister: this.data.cashRegister,
                    lastUpdate: new Date().toISOString()
                };
                
                try {
                    await fetch(`${JSONBIN_API}/b/${this.data.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': '$2b$10$vvf.lentini.master.key.2024.secure.access'
                        },
                        body: JSON.stringify(dataToSave)
                    });
                    
                    this.data.lastUpdate = dataToSave.lastUpdate;
                    this.saveLocal();
                    await this.syncCloud();
                } catch (error) {
                    console.log('Salvataggio locale, sync al prossimo ciclo');
                    this.saveLocal();
                }
            },
            
            addMember(name) {
                if (!name.trim()) return;
                this.data.members.push({
                    id: Date.now().toString(),
                    name: name.trim(),
                    balance: 0
                });
                this.saveToCloud();
                this.render();
            },
            
            deleteMember(id) {
                if (!confirm('Sei sicuro di voler eliminare questo vigile?')) return;
                this.data.members = this.data.members.filter(m => m.id !== id);
                this.saveToCloud();
                this.render();
            },
            
            addProduct(name, price, stock) {
                if (!name.trim() || !price || !stock) {
                    alert('Compila tutti i campi!');
                    return;
                }
                
                const totalCost = parseInt(stock) * parseFloat(price);
                const shouldDeduct = confirm(
                    `Stai aggiungendo ${stock} unità di "${name.trim()}" a €${parseFloat(price).toFixed(2)} cadauno.\n\n` +
                    `Costo totale: €${totalCost.toFixed(2)}\n` +
                    `Cassa attuale: €${this.data.cashRegister.toFixed(2)}\n\n` +
                    `Vuoi scaricare €${totalCost.toFixed(2)} dalla cassa?`
                );
                
                if (shouldDeduct) {
                    if (this.data.cashRegister < totalCost) {
                        alert('ATTENZIONE: La cassa non ha abbastanza denaro!\nProdotto aggiunto comunque, ma controlla la cassa.');
                    }
                    this.data.cashRegister -= totalCost;
                    this.data.purchases.unshift({
                        id: Date.now().toString(),
                        description: `Acquisto ${stock}x ${name.trim()}`,
                        amount: totalCost,
                        date: new Date().toISOString()
                    });
                }
                
                this.data.products.push({
                    id: Date.now().toString(),
                    name: name.trim(),
                    price: parseFloat(price),
                    stock: parseInt(stock)
                });
                this.saveToCloud();
                this.render();
            },
            
            deleteProduct(id) {
                if (!confirm('Sei sicuro di voler eliminare questo prodotto?')) return;
                this.data.products = this.data.products.filter(p => p.id !== id);
                this.saveToCloud();
                this.render();
            },
            
            addStock(productId, quantity, product) {
                const totalCost = quantity * product.price;
                const shouldDeduct = confirm(
                    `Stai aggiungendo ${quantity} unità di "${product.name}".\n\n` +
                    `Costo totale: €${totalCost.toFixed(2)}\n` +
                    `Cassa attuale: €${this.data.cashRegister.toFixed(2)}\n\n` +
                    `Vuoi scaricare €${totalCost.toFixed(2)} dalla cassa?`
                );
                
                if (shouldDeduct) {
                    if (this.data.cashRegister < totalCost) {
                        alert('ATTENZIONE: La cassa non ha abbastanza denaro!\nCarico aggiunto comunque, ma controlla la cassa.');
                    }
                    this.data.cashRegister -= totalCost;
                    this.data.purchases.unshift({
                        id: Date.now().toString(),
                        description: `Carico ${quantity}x ${product.name}`,
                        amount: totalCost,
                        date: new Date().toISOString()
                    });
                }
                
                const prod = this.data.products.find(p => p.id === productId);
                if (prod) prod.stock += quantity;
                this.saveToCloud();
                this.render();
            },
            
            sellProduct(productId, payNow) {
                if (!this.data.selectedMember) {
                    alert('Seleziona prima un vigile!');
                    return;
                }
                
                const product = this.data.products.find(p => p.id === productId);
                if (product.stock <= 0) {
                    alert('Prodotto esaurito!');
                    return;
                }
                
                const member = this.data.members.find(m => m.id === this.data.selectedMember);
                
                this.data.transactions.push({
                    id: Date.now().toString(),
                    memberId: member.id,
                    memberName: member.name,
                    productId: product.id,
                    productName: product.name,
                    price: product.price,
                    date: new Date().toISOString(),
                    paid: payNow
                });
                
                product.stock--;
                
                if (payNow) {
                    this.data.cashRegister += product.price;
                } else {
                    member.balance += product.price;
                }
                
                this.saveToCloud();
                this.render();
                alert(`${product.name} registrato per ${member.name}${payNow ? ' (pagato subito)' : ''}`);
            },
            
            payBalance(memberId) {
                const member = this.data.members.find(m => m.id === memberId);
                if (!confirm(`Confermi il pagamento di €${member.balance.toFixed(2)} da ${member.name}?`)) return;
                
                this.data.cashRegister += member.balance;
                member.balance = 0;
                this.saveToCloud();
                this.render();
                alert('Pagamento registrato!');
            },
            
            addPurchase(description, amount) {
                if (!description.trim() || !amount) {
                    alert('Inserisci descrizione e importo!');
                    return;
                }
                
                const amt = parseFloat(amount);
                if (this.data.cashRegister < amt) {
                    if (!confirm('ATTENZIONE: La cassa non ha abbastanza denaro!\nVuoi procedere comunque?')) {
                        return;
                    }
                }
                
                this.data.purchases.unshift({
                    id: Date.now().toString(),
                    description: description.trim(),
                    amount: amt,
                    date: new Date().toISOString()
                });
                
                this.data.cashRegister -= amt;
                this.saveToCloud();
                this.render();
                alert('Acquisto registrato!');
            },
            
            updateCash(amount) {
                const amt = parseFloat(amount);
                if (!isNaN(amt) && amt >= 0) {
                    this.data.cashRegister = amt;
                    this.saveToCloud();
                    this.render();
                }
            },
            
            resetAllBalances() {
                if (!confirm('ATTENZIONE: Questo azzererà tutti i conti. Confermi?')) return;
                
                const totalDebt = this.getTotalDebt();
                this.data.cashRegister += totalDebt;
                this.data.members.forEach(m => m.balance = 0);
                this.saveToCloud();
                this.render();
                alert('Tutti i conti sono stati azzerati e la cassa aggiornata!');
            },
            
            getTotalDebt() {
                return this.data.members.reduce((sum, m) => sum + m.balance, 0);
            },
            
            getTotalPurchases() {
                return this.data.purchases.reduce((sum, p) => sum + p.amount, 0);
            },
            
            getLowStockProducts() {
                return this.data.products.filter(p => p.stock <= 5);
            },
            
            render() {
                const root = document.getElementById('app');
                root.innerHTML = `
                    <div class="max-w-6xl mx-auto p-4">
                        ${this.renderHeader()}
                        ${this.renderTabs()}
                        ${this.renderContent()}
                    </div>
                `;
                this.attachEventListeners();
            },
            
            renderHeader() {
                const lowStock = this.getLowStockProducts();
                return `
                    <div class="bg-red-600 text-white p-6 rounded-t-lg shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M2 21h19v-3H2v3zM20 8H4V5h16v3zm1-7H3c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h18c.55 0 1-.45 1-1V2c0-.55-.45-1-1-1zM2 17h19v-3H2v3z"/>
                                </svg>
                                <div>
                                    <h1 class="text-2xl font-bold">Bar VVF Lentini</h1>
                                    <p class="text-red-100 text-sm">Sistema gestione condiviso - Online</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="app.syncCloud()" class="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg p-2 transition-colors" title="Sincronizza">
                                    <svg class="w-5 h-5 ${this.data.syncing ? 'animate-spin' : ''}" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                                    </svg>
                                </button>
                                ${this.data.lastSync ? `
                                    <div class="text-xs text-red-100">
                                        <div>Sincronizzato</div>
                                        <div>${this.data.lastSync.toLocaleTimeString('it-IT')}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white bg-opacity-20 rounded-lg p-3">
                                <div class="text-red-100 text-sm">Cassa</div>
                                <div class="text-2xl font-bold">€${this.data.cashRegister.toFixed(2)}</div>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-lg p-3">
                                <div class="text-red-100 text-sm">Crediti totali</div>
                                <div class="text-2xl font-bold">€${this.getTotalDebt().toFixed(2)}</div>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-lg p-3">
                                <div class="text-red-100 text-sm">Prodotti</div>
                                <div class="text-2xl font-bold">${this.data.products.length}</div>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-lg p-3">
                                <div class="text-red-100 text-sm">Vigili</div>
                                <div class="text-2xl font-bold">${this.data.members.length}</div>
                            </div>
                        </div>
                        
                        ${lowStock.length > 0 ? `
                            <div class="mt-4 bg-yellow-500 bg-opacity-90 text-white p-3 rounded-lg flex items-start gap-2">
                                <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                                </svg>
                                <div>
                                    <div class="font-semibold">Attenzione: Giacenze basse!</div>
                                    <div class="text-sm">${lowStock.map(p => `${p.name} (${p.stock})`).join(', ')}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            },
            
            renderTabs() {
                const tabs = [
                    { id: 'vendita', label: 'Vendita' },
                    { id: 'magazzino', label: 'Magazzino' },
                    { id: 'conti', label: 'Conti' },
                    { id: 'cassa', label: 'Cassa' },
                    { id: 'vigili', label: 'Vigili' }
                ];
                
                return `
                    <div class="bg-white border-b flex overflow-x-auto">
                        ${tabs.map(tab => `
                            <button onclick="app.data.activeTab='${tab.id}'; app.render();" 
                                class="flex-1 py-4 px-6 font-semibold transition-colors whitespace-nowrap ${this.data.activeTab === tab.id ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                ${tab.label}
                            </button>
                        `).join('')}
                    </div>
                `;
            },
            
            renderContent() {
                return `
                    <div class="bg-white p-6 rounded-b-lg shadow-lg">
                        ${this[`render${this.data.activeTab.charAt(0).toUpperCase() + this.data.activeTab.slice(1)}`]()}
                    </div>
                `;
            },
            
            renderVendita() {
                const sortedMembers = [...this.data.members].sort((a, b) => a.name.localeCompare(b.name));
                return `
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Registra Vendita</h2>
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Seleziona Vigile</label>
                        <select id="member-select" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none">
                            <option value="">-- Seleziona un vigile --</option>
                            ${sortedMembers.map(m => `
                                <option value="${m.id}">${m.name} ${m.balance > 0 ? `(Debito: €${m.balance.toFixed(2)})` : ''}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    ${this.data.selectedMember ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${this.data.products.map(p => `
                                <div class="border-2 rounded-lg p-4 ${p.stock <= 0 ? 'border-gray-300 bg-gray-50 opacity-60' : p.stock <= 5 ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200 hover:border-red-500'} transition-colors">
                                    <div class="font-semibold text-lg mb-1">${p.name}</div>
                                    <div class="text-2xl font-bold text-red-600 mb-1">€${p.price.toFixed(2)}</div>
                                    <div class="text-sm mb-3 font-semibold ${p.stock <= 0 ? 'text-red-600' : p.stock <= 5 ? 'text-yellow-600' : 'text-green-600'}">
                                        Disponibili: ${p.stock}
                                    </div>
                                    ${p.stock > 0 ? `
                                        <div class="flex gap-2">
                                            <button onclick="app.sellProduct('${p.id}', false)" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors font-semibold text-sm">
                                                A credito
                                            </button>
                                            <button onclick="app.sellProduct('${p.id}', true)" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors font-semibold text-sm">
                                                Paga ora
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="text-center py-2 text-red-600 font-semibold text-sm">ESAURITO</div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-12 text-gray-500">Seleziona un vigile per iniziare</div>
                    `}
                `;
            },
            
            renderMagazzino() {
                return `
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Gestione Magazzino</h2>
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold mb-3">Nuovo Prodotto</h3>
                        <div class="flex gap-2 flex-wrap">
                            <input type="text" id="prod-name" placeholder="Nome prodotto" class="flex-1 min-w-[200px] p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none">
                            <input type="number" step="0.10" id="prod-price" placeholder="Prezzo (€)" class="w-32 p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none">
                            <input type="number" id="prod-stock" placeholder="Quantità" class="w-32 p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none">
                            <button onclick="app.handleAddProduct()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold">
                                + Aggiungi
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        ${this.data.products.map(p => `
                            <div class="border-2 rounded-lg p-4 ${p.stock <= 0 ? 'border-red-300 bg-red-50' : p.stock <= 5 ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200'}">
                                <div class="flex justify-between items-center flex-wrap gap-4">
                                    <div class="flex-1 min-w-[200px]">
                                        <div class="font-semibold text-lg">${p.name}</div>
                                        <div class="text-sm text-gray-600">Prezzo: €${p.price.toFixed(2)}</div>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <div class="text-center">
                                            <div class="text-sm text-gray-600">Giacenza</div>
                                            <div class="text-2xl font-bold ${p.stock <= 0 ? 'text-red-600' : p.stock <= 5 ? 'text-yellow-600' : 'text-green-600'}">${p.stock}</div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="app.handleAddStock('${p.id}')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors font-semibold whitespace-nowrap">
                                                + Carico
                                            </button>
                                            <button onclick="app.deleteProduct('${p.id}')" class="text-red-600 hover:text-red-800 transition-colors p-2">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        ${this.data.products.length === 0 ? '<div class="text-center py-12 text-gray-500">Nessun prodotto. Aggiungi il primo!</div>' : ''}
                    </div>
                `;
            },
            
            renderConti() {
                const membersWithDebt = this.data.members.filter(m => m.balance > 0).sort((a, b) => b.balance - a.balance);
                return `
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <h2 class="text-2xl font-bold text-gray-800">Gestione Conti</h2>
                        <button onclick="app.resetAllBalances()" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors font-semibold">
                            Azzera tutti i conti
                        </button>
                    </div>
                    
                    ${membersWithDebt.length > 0 ? `
                        <div class="space-y-3">
                            ${membersWithDebt.map(m => {
                                const trans = this.data.transactions.filter(t => t.memberId === m.id && !t.paid);
                                return `
                                    <div class="border-2 border-gray-200 rounded-lg p-4">
                                        <div class="flex justify-between items-start mb-2 flex-wrap gap-4">
                                            <div>
                                                <div class="font-bold text-lg">${m.name}</div>
                                                <div class="text-sm text-gray-600">${trans.length} prodotti non pagati</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-2xl font-bold text-red-600">€${m.balance.toFixed(2)}</div>
                                                <button onclick="app.payBalance('${m.id}')" class="mt-2 bg-green-500 text-white py-1 px-4 rounded hover:bg-green-600 transition-colors text-sm font-semibold">
                                                    Segna come pagato
                                                </button>
                                            </div>
                                        </div>
                                        <div class="mt-3 pt-3 border-t border-gray-200">
                                            <div class="text-sm text-gray-600 space-y-1">
                                                ${trans.map(t => `
                                                    <div class="flex justify-between">
                                                        <span>${t.productName}</span>
                                                        <span>€${t.price.toFixed(2)}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-12 text-gray-500">Nessun conto in sospeso</div>
                    `}
                `;
            },
            
            renderCassa() {
                const paidTrans = this.data.transactions.filter(t => t.paid).slice(-10).reverse();
                return `
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <h2 class="text-2xl font-bold text-gray-800">Situazione Cassa</h2>
                        <button onclick="app.showPurchaseModal()" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors font-semibold flex items-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M18 6h-2c0-2.21-1.79-4-4-4S8 3.79 8 6H6c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/>
                            </svg>
                            Registra Acquisto
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">Denaro in cassa</div>
                            <div class="text-3xl font-bold text-green-600 mb-2">€${this.data.cashRegister.toFixed(2)}</div>
                            <button onclick="app.showEditCash()" class="text-sm text-green-600 hover:text-green-700 font-semibold">
                                Modifica cassa iniziale
                            </button>
                        </div>
                        
                        <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">Crediti da riscuotere</div>
                            <div class="text-3xl font-bold text-orange-600">€${this.getTotalDebt().toFixed(2)}</div>
                        </div>
                        
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                            <div class="text-sm text-gray-600 mb-1">Totale previsto</div>
                            <div class="text-3xl font-bold text-blue-600">€${(this.data.cashRegister + this.getTotalDebt()).toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-6">
                        <div class="text-sm text-gray-600 mb-1">Totale acquisti registrati</div>
                        <div class="text-2xl font-bold text-red-600">€${this.getTotalPurchases().toFixed(2)}</div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-3">Ultimi Acquisti</h3>
                        <div class="space-y-2">
                            ${this.data.purchases.slice(0, 10).map(p => `
                                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg border border-red-200 flex-wrap gap-2">
                                    <div class="flex-1 min-w-[200px]">
                                        <div class="font-semibold">${p.description}</div>
                                        <div class="text-sm text-gray-600">${new Date(p.date).toLocaleString('it-IT')}</div>
                                    </div>
                                    <div class="text-lg font-bold text-red-600">-€${p.amount.toFixed(2)}</div>
                                </div>
                            `).join('') || '<div class="text-center py-6 text-gray-500">Nessun acquisto registrato</div>'}
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold mb-3">Ultimi Incassi</h3>
                        <div class="space-y-2">
                            ${paidTrans.map(t => `
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-200 flex-wrap gap-2">
                                    <div class="flex-1 min-w-[200px]">
                                        <div class="font-semibold">${t.memberName}</div>
                                        <div class="text-sm text-gray-600">${t.productName} - ${new Date(t.date).toLocaleString('it-IT')}</div>
                                    </div>
                                    <div class="text-lg font-bold text-green-600">+€${t.price.toFixed(2)}</div>
                                </div>
                            `).join('') || '<div class="text-center py-6 text-gray-500">Nessun incasso registrato</div>'}
                        </div>
                    </div>
                `;
            },
            
            renderVigili() {
                const sortedMembers = [...this.data.members].sort((a, b) => a.name.localeCompare(b.name));
                return `
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Gestione Vigili</h2>
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="flex gap-2 flex-wrap">
                            <input type="text" id="member-name" placeholder="Nome e Cognome" class="flex-1 min-w-[200px] p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none">
                            <button onclick="app.handleAddMember()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                </svg>
                                Aggiungi
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        ${sortedMembers.map(m => `
                            <div class="flex justify-between items-center p-4 border-2 border-gray-200 rounded-lg hover:border-red-500 transition-colors flex-wrap gap-4">
                                <div class="flex-1 min-w-[200px]">
                                    <div class="font-semibold text-lg">${m.name}</div>
                                    <div class="text-sm text-gray-600">Debito attuale: €${m.balance.toFixed(2)}</div>
                                </div>
                                <button onclick="app.deleteMember('${m.id}')" class="text-red-600 hover:text-red-800 transition-colors p-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                        ${sortedMembers.length === 0 ? '<div class="text-center py-12 text-gray-500">Nessun vigile. Aggiungi il primo!</div>' : ''}
                    </div>
                `;
            },
            
            attachEventListeners() {
                const memberSelect = document.getElementById('member-select');
                if (memberSelect) {
                    memberSelect.value = this.data.selectedMember;
                    memberSelect.addEventListener('change', (e) => {
                        this.data.selectedMember = e.target.value;
                        this.render();
                    });
                }
            },
            
            handleAddMember() {
                const input = document.getElementById('member-name');
                if (input && input.value.trim()) {
                    this.addMember(input.value);
                }
            },
            
            handleAddProduct() {
                const name = document.getElementById('prod-name').value;
                const price = document.getElementById('prod-price').value;
                const stock = document.getElementById('prod-stock').value;
                this.addProduct(name, price, stock);
            },
            
            handleAddStock(productId) {
                const qty = prompt('Quante unità vuoi aggiungere?', '10');
                if (qty && !isNaN(qty) && parseInt(qty) > 0) {
                    const product = this.data.products.find(p => p.id === productId);
                    this.addStock(productId, parseInt(qty), product);
                }
            },
            
            showEditCash() {
                const amount = prompt('Inserisci nuovo importo in cassa:', this.data.cashRegister);
                if (amount !== null) {
                    this.updateCash(amount);
                }
            },
            
            showPurchaseModal() {
                const description = prompt('Descrizione acquisto (es: Acquisto bibite):');
                if (!description) return;
                
                const amount = prompt('Importo (€):');
                if (!amount) return;
                
                this.addPurchase(description, amount);
            }
        };
        
        // Avvia l'app
        window.app = app;
        app.init();
    </script>
</body>
</html>
