<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bar VVF">
    <title>Bar VVF Lentini</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöí</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%23dc2626' rx='48'/><text x='96' y='145' font-size='120' text-anchor='middle' fill='white'>üöí</text></svg>">
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #fee2e2 0%, #fed7aa 100%); min-height: 100vh; padding: 1rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #dc2626; color: white; padding: 1.5rem; border-radius: 0.5rem 0.5rem 0 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        .header h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .header p { font-size: 0.875rem; opacity: 0.9; }
        .sync-indicator { position: absolute; top: 1rem; right: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; background: rgba(255,255,255,0.2); padding: 0.5rem 0.75rem; border-radius: 0.375rem; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .sync-dot.syncing { background: #f59e0b; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 1rem; }
        .stat { background: rgba(255,255,255,0.2); padding: 0.75rem; border-radius: 0.375rem; }
        .stat-label { font-size: 0.75rem; margin-bottom: 0.25rem; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .tabs { background: white; display: flex; border-bottom: 2px solid #e5e7eb; }
        .tab { flex: 1; padding: 1rem 0.5rem; text-align: center; font-weight: 600; cursor: pointer; border: none; background: #f3f4f6; color: #6b7280; font-size: 0.875rem; }
        .tab.active { background: #dc2626; color: white; }
        .content { background: white; padding: 1.5rem; border-radius: 0 0 0.5rem 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-height: 400px; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer; font-size: 0.875rem; }
        .btn-primary { background: #dc2626; color: white; }
        .btn-primary:hover { background: #b91c1c; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-warning { background: #ea580c; color: white; }
        .btn-warning:hover { background: #c2410c; }
        input, select { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.375rem; font-size: 0.875rem; width: 100%; }
        input:focus, select:focus { outline: none; border-color: #dc2626; }
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .card { border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; }
        .card-header { font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem; }
        .card-price { font-size: 1.5rem; font-weight: bold; color: #dc2626; margin: 0.5rem 0; }
        .card-stock { font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; }
        .stock-ok { color: #16a34a; }
        .stock-low { color: #ea580c; }
        .stock-out { color: #dc2626; }
        .flex { display: flex; gap: 0.5rem; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 2rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-gray { color: #6b7280; }
        .alert { padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem; }
        .alert-warning { background: #fef3c7; border: 2px solid #fbbf24; color: #78350f; }
        .alert-success { background: #d1fae5; border: 2px solid #34d399; color: #065f46; }
        .alert-info { background: #dbeafe; border: 2px solid #60a5fa; color: #1e3a8a; }
        .bg-gray { background: #f9fafb; padding: 1rem; border-radius: 0.375rem; }
        h2 { font-size: 1.5rem; margin-bottom: 1rem; }
        h3 { font-size: 1.125rem; margin-bottom: 0.75rem; font-weight: 600; }
        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .tab { font-size: 0.75rem; padding: 0.75rem 0.25rem; }
            .sync-indicator { font-size: 0.65rem; padding: 0.375rem 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöí Bar VVF Lentini</h1>
            <p>Sistema Gestione Condiviso - Sincronizzazione Cloud</p>
            <div class="sync-indicator" id="sync-status">
                <div class="sync-dot" id="sync-dot"></div>
                <span id="sync-text">Connessione...</span>
            </div>
            <div class="stats" id="stats"></div>
        </div>
        
        <div class="tabs" id="tabs"></div>
        
        <div class="content" id="content"></div>
    </div>

    <script>
        const FIREBASE_URL = 'https://bar-vvf-lentini-default-rtdb.europe-west1.firebasedatabase.app';
        
        const app = {
            data: {
                members: [],
                products: [],
                transactions: [],
                purchases: [],
                cashRegister: 0,
                activeTab: 'setup',
                selectedMember: '',
                lastSync: null,
                syncing: false,
                online: true
            },
            
            async init() {
                this.render();
                await this.syncFromCloud();
                
                // Auto-sync ogni 3 secondi
                setInterval(() => this.syncFromCloud(), 3000);
            },
            
            async syncFromCloud() {
                this.data.syncing = true;
                this.updateSyncStatus();
                
                try {
                    const response = await fetch(`${FIREBASE_URL}/bar-data.json`);
                    
                    if (response.ok) {
                        const cloudData = await response.json();
                        
                        if (cloudData) {
                            this.data.members = cloudData.members || [];
                            this.data.products = cloudData.products || [];
                            this.data.transactions = cloudData.transactions || [];
                            this.data.purchases = cloudData.purchases || [];
                            this.data.cashRegister = cloudData.cashRegister || 0;
                            
                            // Salva anche in locale come backup
                            this.saveLocal();
                        }
                        
                        this.data.online = true;
                        this.data.lastSync = new Date();
                    }
                } catch (error) {
                    console.log('Modalit√† offline, usando dati locali');
                    this.loadLocal();
                    this.data.online = false;
                }
                
                this.data.syncing = false;
                this.updateSyncStatus();
                
                // Controlla se l'utente sta scrivendo in un input
                const activeElement = document.activeElement;
                const isTyping = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT' || activeElement.tagName === 'TEXTAREA');
                
                // Non fare render se l'utente sta scrivendo
                if (!isTyping) {
                    this.render();
                } else {
                    // Aggiorna solo le statistiche
                    this.renderStats();
                }
            },
            
            async saveToCloud() {
                const dataToSave = {
                    members: this.data.members,
                    products: this.data.products,
                    transactions: this.data.transactions,
                    purchases: this.data.purchases,
                    cashRegister: this.data.cashRegister,
                    lastUpdate: new Date().toISOString()
                };
                
                try {
                    const response = await fetch(`${FIREBASE_URL}/bar-data.json`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToSave)
                    });
                    
                    if (response.ok) {
                        this.data.online = true;
                        this.saveLocal();
                        // NON facciamo sync subito per non interferire con l'input
                        // Il sync automatico lo far√† dopo 3 secondi
                        this.renderStats(); // Aggiorna solo le statistiche
                    }
                } catch (error) {
                    console.log('Errore salvataggio cloud, salvato solo in locale');
                    this.saveLocal();
                    this.data.online = false;
                }
            },
            
            saveLocal() {
                try {
                    localStorage.setItem('vvf-members', JSON.stringify(this.data.members));
                    localStorage.setItem('vvf-products', JSON.stringify(this.data.products));
                    localStorage.setItem('vvf-transactions', JSON.stringify(this.data.transactions));
                    localStorage.setItem('vvf-purchases', JSON.stringify(this.data.purchases));
                    localStorage.setItem('vvf-cash', this.data.cashRegister.toString());
                } catch (e) {
                    console.log('Errore salvataggio locale');
                }
            },
            
            loadLocal() {
                try {
                    this.data.members = JSON.parse(localStorage.getItem('vvf-members') || '[]');
                    this.data.products = JSON.parse(localStorage.getItem('vvf-products') || '[]');
                    this.data.transactions = JSON.parse(localStorage.getItem('vvf-transactions') || '[]');
                    this.data.purchases = JSON.parse(localStorage.getItem('vvf-purchases') || '[]');
                    this.data.cashRegister = parseFloat(localStorage.getItem('vvf-cash') || '0');
                } catch (e) {
                    console.log('Primo avvio');
                }
            },
            
            updateSyncStatus() {
                const dot = document.getElementById('sync-dot');
                const text = document.getElementById('sync-text');
                
                if (!dot || !text) return;
                
                if (this.data.syncing) {
                    dot.className = 'sync-dot syncing';
                    text.textContent = 'Sincronizzazione...';
                } else if (this.data.online) {
                    dot.className = 'sync-dot';
                    if (this.data.lastSync) {
                        text.textContent = 'Online ‚Ä¢ ' + this.data.lastSync.toLocaleTimeString('it-IT');
                    } else {
                        text.textContent = 'Online';
                    }
                } else {
                    dot.style.background = '#ef4444';
                    text.textContent = 'Offline';
                }
            },
            
            render() {
                this.renderStats();
                this.renderTabs();
                this.renderContent();
                this.updateSyncStatus();
            },
            
            renderStats() {
                const statsEl = document.getElementById('stats');
                if (!statsEl) return;
                
                statsEl.innerHTML = `
                    <div class="stat">
                        <div class="stat-label">Cassa</div>
                        <div class="stat-value">‚Ç¨${this.data.cashRegister.toFixed(2)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Vigili</div>
                        <div class="stat-value">${this.data.members.length}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Prodotti</div>
                        <div class="stat-value">${this.data.products.length}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Crediti</div>
                        <div class="stat-value">‚Ç¨${this.getTotalDebt().toFixed(2)}</div>
                    </div>
                `;
            },
            
            renderTabs() {
                const tabs = ['setup', 'vendita', 'magazzino', 'conti', 'cassa'];
                document.getElementById('tabs').innerHTML = tabs.map(tab => 
                    `<button class="tab ${this.data.activeTab === tab ? 'active' : ''}" onclick="app.switchTab('${tab}')">
                        ${tab.charAt(0).toUpperCase() + tab.slice(1)}
                    </button>`
                ).join('');
            },
            
            renderContent() {
                const method = 'render' + this.data.activeTab.charAt(0).toUpperCase() + this.data.activeTab.slice(1);
                document.getElementById('content').innerHTML = this[method]();
            },
            
            switchTab(tab) {
                this.data.activeTab = tab;
                this.render();
            },
            
            getTotalDebt() {
                return this.data.members.reduce((sum, m) => sum + (m.balance || 0), 0);
            },
            
            renderSetup() {
                return `
                    <h2>‚öôÔ∏è Configurazione Iniziale</h2>
                    
                    ${!this.data.online ? 
                        '<div class="alert alert-warning"><strong>‚ö†Ô∏è Modalit√† Offline</strong><br>I dati verranno sincronizzati quando tornerai online.</div>' : 
                        '<div class="alert alert-info"><strong>‚òÅÔ∏è Connesso al Cloud</strong><br>Tutti i dispositivi vedono gli stessi dati in tempo reale.</div>'
                    }
                    
                    ${this.data.members.length > 0 && this.data.products.length > 0 ? 
                        '<div class="alert alert-success"><strong>‚úÖ Sistema configurato!</strong><br>Puoi usare le altre tab per gestire il bar.</div>' : 
                        '<div class="alert alert-warning"><strong>‚ö†Ô∏è Configurazione necessaria</strong><br>Completa i passi sotto per iniziare.</div>'
                    }
                    
                    <div class="grid grid-2">
                        <div class="card">
                            <h3>1Ô∏è‚É£ Cassa Iniziale</h3>
                            <input type="number" id="cash-input" placeholder="Es: 50.00" value="${this.data.cashRegister}" class="mb-1">
                            <button class="btn btn-success" onclick="app.setCash()" style="width:100%">Imposta Cassa</button>
                        </div>
                        
                        <div class="card">
                            <h3>2Ô∏è‚É£ Aggiungi Vigili (${this.data.members.length})</h3>
                            <input type="text" id="member-input" placeholder="Nome Cognome" class="mb-1">
                            <button class="btn btn-primary" onclick="app.addMember()" style="width:100%">Aggiungi Vigile</button>
                        </div>
                    </div>
                    
                    <div class="card mb-2">
                        <h3>3Ô∏è‚É£ Aggiungi Prodotti (${this.data.products.length})</h3>
                        <div class="flex mb-1">
                            <input type="text" id="prod-name" placeholder="Nome" style="flex:2">
                            <input type="number" id="prod-price" placeholder="‚Ç¨" step="0.10" style="flex:1">
                            <input type="number" id="prod-stock" placeholder="Pz" style="flex:1">
                        </div>
                        <button class="btn btn-primary" onclick="app.addProduct()" style="width:100%">Aggiungi Prodotto</button>
                    </div>
                    
                    ${this.data.members.length > 0 ? `
                        <details open>
                            <summary style="cursor:pointer;font-weight:600;margin-bottom:0.5rem">üë• Vigili Inseriti (${this.data.members.length})</summary>
                            <div class="grid grid-3">
                                ${this.data.members.map(m => `
                                    <div class="card" style="padding:0.5rem">
                                        <div class="text-sm">${m.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    ` : ''}
                    
                    ${this.data.products.length > 0 ? `
                        <details open style="margin-top:1rem">
                            <summary style="cursor:pointer;font-weight:600;margin-bottom:0.5rem">üì¶ Prodotti Inseriti (${this.data.products.length})</summary>
                            <div class="grid grid-3">
                                ${this.data.products.map(p => `
                                    <div class="card" style="padding:0.5rem">
                                        <div class="text-sm"><strong>${p.name}</strong></div>
                                        <div class="text-sm text-gray">‚Ç¨${p.price.toFixed(2)} - Stock: ${p.stock}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    ` : ''}
                `;
            },
            
            async setCash() {
                const val = document.getElementById('cash-input').value;
                this.data.cashRegister = parseFloat(val) || 0;
                await this.saveToCloud();
                alert('‚úÖ Cassa impostata e sincronizzata!');
            },
            
            async addMember() {
                const input = document.getElementById('member-input');
                const name = input ? input.value.trim() : '';
                if (!name) { alert('Inserisci un nome!'); return; }
                
                this.data.members.push({ id: Date.now().toString(), name: name, balance: 0 });
                await this.saveToCloud();
                
                // Pulisce l'input senza fare render completo
                if (input) {
                    input.value = '';
                    input.focus();
                }
                
                // Aggiorna solo la lista dei membri visualizzati
                this.updateMembersList();
            },
            
            updateMembersList() {
                const container = document.querySelector('details');
                if (container && this.data.activeTab === 'setup') {
                    // Trova il details per i membri e lo aggiorna
                    const allDetails = document.querySelectorAll('details');
                    if (allDetails[0]) {
                        allDetails[0].innerHTML = `
                            <summary style="cursor:pointer;font-weight:600;margin-bottom:0.5rem">üë• Vigili Inseriti (${this.data.members.length})</summary>
                            <div class="grid grid-3">
                                ${this.data.members.map(m => `
                                    <div class="card" style="padding:0.5rem">
                                        <div class="text-sm">${m.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        allDetails[0].open = true;
                    }
                }
            },
            
            async addProduct() {
                const nameInput = document.getElementById('prod-name');
                const priceInput = document.getElementById('prod-price');
                const stockInput = document.getElementById('prod-stock');
                
                const name = nameInput ? nameInput.value.trim() : '';
                const price = priceInput ? priceInput.value : '';
                const stock = stockInput ? stockInput.value : '';
                
                if (!name || !price || !stock) { alert('Compila tutti i campi!'); return; }
                
                this.data.products.push({
                    id: Date.now().toString(),
                    name: name,
                    price: parseFloat(price),
                    stock: parseInt(stock)
                });
                
                await this.saveToCloud();
                
                // Pulisce gli input senza fare render completo
                if (nameInput) nameInput.value = '';
                if (priceInput) priceInput.value = '';
                if (stockInput) stockInput.value = '';
                if (nameInput) nameInput.focus();
                
                // Aggiorna solo la lista dei prodotti
                this.updateProductsList();
            },
            
            updateProductsList() {
                const allDetails = document.querySelectorAll('details');
                if (allDetails[1] && this.data.activeTab === 'setup') {
                    allDetails[1].innerHTML = `
                        <summary style="cursor:pointer;font-weight:600;margin-bottom:0.5rem">üì¶ Prodotti Inseriti (${this.data.products.length})</summary>
                        <div class="grid grid-3">
                            ${this.data.products.map(p => `
                                <div class="card" style="padding:0.5rem">
                                    <div class="text-sm"><strong>${p.name}</strong></div>
                                    <div class="text-sm text-gray">‚Ç¨${p.price.toFixed(2)} - Stock: ${p.stock}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    allDetails[1].open = true;
                }
            },
            
            renderVendita() {
                if (this.data.members.length === 0 || this.data.products.length === 0) {
                    return '<div class="alert alert-warning"><strong>‚ö†Ô∏è Vai alla tab "Setup"</strong><br>Devi prima configurare vigili e prodotti.</div>';
                }
                
                return `
                    <h2>üõí Registra Vendita</h2>
                    
                    <div class="bg-gray mb-2">
                        <label style="display:block;font-weight:600;margin-bottom:0.5rem">Seleziona Vigile:</label>
                        <select id="member-select" onchange="app.data.selectedMember=this.value; app.render()">
                            <option value="">-- Scegli --</option>
                            ${this.data.members.map(m => 
                                `<option value="${m.id}" ${this.data.selectedMember === m.id ? 'selected' : ''}>
                                    ${m.name} ${m.balance > 0 ? '(‚Ç¨' + m.balance.toFixed(2) + ')' : ''}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    ${!this.data.selectedMember ? 
                        '<p class="text-center text-gray" style="padding:3rem">Seleziona un vigile per vedere i prodotti</p>' :
                        `<div class="grid grid-3">
                            ${this.data.products.map(p => `
                                <div class="card ${p.stock <= 0 ? 'bg-gray' : ''}">
                                    <div class="card-header">${p.name}</div>
                                    <div class="card-price">‚Ç¨${p.price.toFixed(2)}</div>
                                    <div class="card-stock ${p.stock <= 0 ? 'stock-out' : p.stock <= 5 ? 'stock-low' : 'stock-ok'}">
                                        Stock: ${p.stock}
                                    </div>
                                    ${p.stock > 0 ? `
                                        <div class="flex">
                                            <button class="btn btn-warning" style="flex:1" onclick="app.sell('${p.id}',false)">Credito</button>
                                            <button class="btn btn-success" style="flex:1" onclick="app.sell('${p.id}',true)">Paga</button>
                                        </div>
                                    ` : '<div class="text-center" style="padding:0.5rem;color:#dc2626;font-weight:600">ESAURITO</div>'}
                                </div>
                            `).join('')}
                        </div>`
                    }
                `;
            },
            
            async sell(prodId, payNow) {
                if (!this.data.selectedMember) { alert('Seleziona un vigile!'); return; }
                
                const member = this.data.members.find(m => m.id === this.data.selectedMember);
                const product = this.data.products.find(p => p.id === prodId);
                
                if (product.stock <= 0) { alert('Prodotto esaurito!'); return; }
                
                product.stock--;
                
                this.data.transactions.push({
                    id: Date.now().toString(),
                    memberId: member.id,
                    memberName: member.name,
                    productName: product.name,
                    price: product.price,
                    date: new Date().toISOString(),
                    paid: payNow
                });
                
                if (payNow) {
                    this.data.cashRegister += product.price;
                } else {
                    member.balance = (member.balance || 0) + product.price;
                }
                
                await this.saveToCloud();
                alert(`‚úÖ ${product.name} venduto a ${member.name}` + (payNow ? ' (pagato)' : ' (a credito)'));
            },
            
            renderMagazzino() {
                return `
                    <h2>üì¶ Gestione Magazzino</h2>
                    ${this.data.products.length === 0 ? 
                        '<div class="alert alert-warning">Nessun prodotto. Vai alla tab "Setup" per aggiungerne.</div>' :
                        `<div class="grid">
                            ${this.data.products.map(p => `
                                <div class="card">
                                    <div class="flex-between" style="margin-bottom:0.5rem">
                                        <div style="flex:1">
                                            <div style="font-weight:600;font-size:1.125rem">${p.name}</div>
                                            <div class="text-sm text-gray">Prezzo: ‚Ç¨${p.price.toFixed(2)}</div>
                                        </div>
                                        <div style="text-align:right">
                                            <div class="text-sm text-gray">Giacenza</div>
                                            <div style="font-size:1.875rem;font-weight:bold" class="${p.stock <= 0 ? 'stock-out' : p.stock <= 5 ? 'stock-low' : 'stock-ok'}">
                                                ${p.stock}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex" style="gap:0.5rem">
                                        <button class="btn btn-success" style="flex:1" onclick="app.addStock('${p.id}')">+ Carico</button>
                                        <button onclick="app.editProduct('${p.id}')" style="background:#6b7280;color:white;border:none;padding:0.5rem;border-radius:0.375rem;cursor:pointer;font-weight:600" title="Modifica">‚úèÔ∏è</button>
                                        <button onclick="app.deleteProduct('${p.id}')" style="background:#dc2626;color:white;border:none;padding:0.5rem;border-radius:0.375rem;cursor:pointer;font-weight:600" title="Elimina">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`
                    }
                `;
            },
            
            async addStock(prodId) {
                const qty = prompt('Quanti pezzi vuoi aggiungere?', '10');
                if (!qty || parseInt(qty) <= 0) return;
                
                const product = this.data.products.find(p => p.id === prodId);
                const quantity = parseInt(qty);
                const totalCost = quantity * product.price;
                
                if (confirm(`Costo totale: ‚Ç¨${totalCost.toFixed(2)}\n\nScaricare dalla cassa?`)) {
                    this.data.cashRegister -= totalCost;
                    this.data.purchases.unshift({
                        id: Date.now().toString(),
                        description: `Carico ${quantity}x ${product.name}`,
                        amount: totalCost,
                        date: new Date().toISOString()
                    });
                }
                
                product.stock += quantity;
                await this.saveToCloud();
                alert('‚úÖ Stock aggiornato e sincronizzato!');
            },
            
            renderConti() {
                const withDebt = this.data.members.filter(m => (m.balance || 0) > 0).sort((a,b) => b.balance - a.balance);
                
                return `
                    <h2>üí∞ Gestione Conti</h2>
                    ${withDebt.length === 0 ? 
                        '<p class="text-center text-gray" style="padding:3rem">Nessun debito da riscuotere</p>' :
                        `<div class="grid">
                            ${withDebt.map(m => {
                                const trans = this.data.transactions.filter(t => t.memberId === m.id && !t.paid);
                                return `
                                    <div class="card">
                                        <div class="flex-between mb-1">
                                            <div>
                                                <div style="font-weight:600;font-size:1.125rem">${m.name}</div>
                                                <div class="text-sm text-gray">${trans.length} prodotti non pagati</div>
                                            </div>
                                            <div style="text-align:right">
                                                <div style="font-size:1.5rem;font-weight:bold;color:#dc2626">‚Ç¨${m.balance.toFixed(2)}</div>
                                                <button class="btn btn-success" style="margin-top:0.25rem" onclick="app.payDebt('${m.id}')">Paga</button>
                                            </div>
                                        </div>
                                        <details>
                                            <summary style="cursor:pointer;font-size:0.875rem;color:#6b7280">Dettaglio</summary>
                                            <div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid #e5e7eb">
                                                ${trans.map(t => `
                                                    <div class="flex-between text-sm" style="margin-bottom:0.25rem">
                                                        <span>${t.productName}</span>
                                                        <span style="font-weight:600">‚Ç¨${t.price.toFixed(2)}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </details>
                                    </div>
                                `;
                            }).join('')}
                        </div>`
                    }
                `;
            },
            
            async payDebt(memberId) {
                const member = this.data.members.find(m => m.id === memberId);
                if (!confirm(`Confermi pagamento di ‚Ç¨${member.balance.toFixed(2)} da ${member.name}?`)) return;
                
                this.data.cashRegister += member.balance;
                member.balance = 0;
                await this.saveToCloud();
                alert('‚úÖ Pagamento registrato e sincronizzato!');
            },
            
            renderCassa() {
                return `
                    <h2>üíµ Situazione Cassa</h2>
                    
                    <div class="grid grid-3 mb-4">
                        <div class="card" style="background:#d1fae5;border-color:#34d399">
                            <div class="text-sm text-gray">Denaro in cassa</div>
                            <div style="font-size:2rem;font-weight:bold;color:#16a34a">‚Ç¨${this.data.cashRegister.toFixed(2)}</div>
                            <button onclick="app.editCash()" style="margin-top:0.5rem;background:transparent;border:none;color:#16a34a;font-weight:600;cursor:pointer;font-size:0.875rem">Modifica</button>
                        </div>
                        <div class="card" style="background:#fed7aa;border-color:#fb923c">
                            <div class="text-sm text-gray">Crediti da riscuotere</div>
                            <div style="font-size:2rem;font-weight:bold;color:#ea580c">‚Ç¨${this.getTotalDebt().toFixed(2)}</div>
                        </div>
                        <div class="card" style="background:#dbeafe;border-color:#60a5fa">
                            <div class="text-sm text-gray">Totale previsto</div>
                            <div style="font-size:2rem;font-weight:bold;color:#2563eb">‚Ç¨${(this.data.cashRegister + this.getTotalDebt()).toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mb-2" onclick="app.addPurchase()" style="width:100%">üìù Registra Acquisto</button>
                    
                    <h3>Ultimi Acquisti</h3>
                    ${this.data.purchases.length === 0 ?
                        '<p class="text-center text-gray" style="padding:2rem">Nessun acquisto registrato</p>' :
                        `<div class="grid">
                            ${this.data.purchases.slice(0, 10).map(p => `
                                <div class="card" style="background:#fee2e2;border-color:#fca5a5">
                                    <div class="flex-between">
                                        <div>
                                            <div style="font-weight:600">${p.description}</div>
                                            <div class="text-sm text-gray">${new Date(p.date).toLocaleString('it-IT')}</div>
                                        </div>
                                        <div style="font-size:1.25rem;font-weight:bold;color:#dc2626">-‚Ç¨${p.amount.toFixed(2)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`
                    }
                `;
            },
            
            async editCash() {
                const val = prompt('Nuovo importo in cassa:', this.data.cashRegister);
                if (val === null) return;
                this.data.cashRegister = parseFloat(val) || 0;
                await this.saveToCloud();
                alert('‚úÖ Cassa aggiornata e sincronizzata!');
            },
            
            async addPurchase() {
                const desc = prompt('Descrizione acquisto (es: Bibite, caff√®...):');
                if (!desc) return;
                const amount = prompt('Importo in euro:');
                if (!amount) return;
                
                const amt = parseFloat(amount);
                this.data.purchases.unshift({
                    id: Date.now().toString(),
                    description: desc.trim(),
                    amount: amt,
                    date: new Date().toISOString()
                });
                this.data.cashRegister -= amt;
                await this.saveToCloud();
                alert('‚úÖ Acquisto registrato e sincronizzato!');
            }
        };
        
        window.app = app;
        app.init();
    </script>
</body>
</html>